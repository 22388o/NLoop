## Manual testing with docker-compose

### Service dependencies graph.

![Test dependency graph](../../images/test_deps.png)

### How-to

Note that this requires .NET SDK with compatible version installed.

You also have to enable [docker buildkit](https://docs.docker.com/develop/develop-images/build_enhancements/), by setting

```bash
DOCKER_BUILDKIT=1
COMPOSE_DOCKER_CLI_BUILD=1
```


```sh
# --- prepare dependent services ---
cd tests/NLoop.Server.Tests

docker-compose up -d # Start dependencies such as bitcoind and lnd

# regtest blockchain is too empty that clients fails to estimate the fee.
# So fill in some dummy tx's and funds by this command, it may take a while to complete.
# This is necessary only for performing an actual swap and not for running the server itself.
./cliutils/prepare_tx_for_fee.sh

# you can also use these scripts for invoking RPC methods for bitcoind, lnd.
./docker-bitcoin-cli.sh getblockchaininfo
./docker-litecoin-cli.sh getblockchaininfo
./docker-lncli-user.sh getinfo
./docker-lncli-server_ltc.sh getinfo
# Some interactive operation (e.g. lnd's `payinvoice`) may require you to execute it with the pseudo-tty.
# in that case do not use these scripts and run `docker-compose exec` without `-T` option

cd ../..
# --- ---

# --- start running nloopd ---

# You must run this as a same user with a `docker-compose`.
# Since it reads files in `tests/NLoop.Server.Tests/data` generated by the docker-compose command above.
./scripts/start_with_local_docker.sh

# --- ---

# Get general information about NLoop.
curl http://localhost:5000/v1/info

```

You can access http://localhost:2113 for EventStoreDB admin ui to check the current state of the db.

To reset the state, you can just run the following commands after stopping the docker-compose.

```sh
cd tests/NLoop.Server.Tests
rm -rf data
git checkout -- data
```

For tests those which have a trait "Docker=On", you should first run `docker-compose up` in the background,
These tests are too heavy that it won't run in the CI, but it is necessary to assure the health of the app.

### testing the behaviour for running nloopd as a c-lightning plugin.

clightning requires its plugin to live in the same docker image since it communicates with each other with
stdin/out, thus, we must first build `nloopd` docker image and inherit clightning image from it.
We do this by using [dockerfile-plus](https://github.com/edrevo/dockerfile-plus).

We also have a separate docker-compose file, so to run clightning image which contains nloop, run

```bash
docker-compose -f docker-compose.yml -f docker-compose.clightning.yml up clightning_user
```
